"use strict";angular.module("nn.balanceChanger",["ui.bootstrap"]).run(["$templateCache",function(e){e.put("balance-changer/control.html",'\n\t\t<div class="balance-changer-control">\n\t\t\t<button class="btn btn-xs btn-danger" ng-click="$ctrl.open(\'withdraw\')" ng-if="$ctrl.model.buttons.w" title="{{ ::__(\'balanceChanger\', \'type.withdraw\') }}">-</button>\n\t\t\t<button class="btn btn-xs btn-success" ng-click="$ctrl.open(\'deposit\')" ng-if="$ctrl.model.buttons.d && !$ctrl.model.buttons.w" title="{{ ::__(\'balanceChanger\', \'type.deposit\') }}">+</button>\n\t\t\t<span>{{ $ctrl.model.subject.model[$ctrl.balanceField] | nnCurrency }}</span>\n\t\t\t<button class="btn btn-xs btn-success" ng-click="$ctrl.open(\'deposit\')" ng-if="$ctrl.model.buttons.d && $ctrl.model.buttons.w" title="{{ ::__(\'balanceChanger\', \'type.deposit\') }}">+</button>\n\t\t\t<button class="btn btn-xs" ng-click="$ctrl.open(\'ss\')" ng-if="$ctrl.model.buttons.ss && $root.Auth.cashier.can_move_sweepstakes" title="{{ ::__(\'balanceChanger\', \'type.sweepstakes\') }}">SS</button>\n\t\t</div>')}]).component("balanceChangerControl",{templateUrl:"balance-changer/control.html",bindings:{model:"="},controller:["$scope","$uibModal","Auth","Remote","Alert",function(e,t,o,n,a){var l=this.model;_.defaults(l,{amount:0,method:"Cashier.BankGroup.Transaction.moveMoney",buttons:{w:1,d:1,ss:0},object:{type:"bankGroup"},ssDirection:"win2bet",bonus:null,balanceType:null}),l.subject.field?l.subject.field.basic?this.balanceField=l.subject.field.basic:this.balanceField=l.subject.field:this.balanceField="balance",l.balanceField=this.balanceField,this.open=function(e){o.agent?l.object.model=o.agent:"playerId"===l.subject.type?l.object.model=l.subject.model.bankGroup:"bankGroup"===l.subject.type&&(l.object.model=l.subject.model.parent),l.type=e,delete l.amount;var n="balanceChangerBasicComponent";"ss"===e?(n="balanceChangerSweepstakesComponent",l.type=l.ssDirection):"bonusBalance"!==l.balanceType&&"wagerCounter"!==l.balanceType||(n="balanceChangerBWComponent"),t.open({component:n,size:"sm",resolve:{model:l}})}}]}).component("balanceChangerBasicComponent",{templateUrl:VIEW_PATH+"/partials/balance-changer/modal-basic.html",bindings:{close:"&",dismiss:"&",resolve:"="},controller:["$scope","Remote","Alert","$filter",function(n,a,l,s){var r=this;_.extend(this,this.resolve);var i=this;i.processing=!0,i.validateBonus=function(){var e=objPath(i.model,"bonus.deposit_min"),n=objPath(i.model,"bonus.deposit_max"),t=i.model.amount;return e<=t&&t<=n},i.ok=function(){if(_.isUndefined(i.model.amount)||i.model.amount<=0)return l.Big.Simple.Error("Amount has to be positive and greater than zero.");var e={amount:i.model.amount},t=null;switch(i.model.type){case"deposit":e.from=[i.model.object.type,objPath(i.model.object.model,"id")],e.to=[i.model.subject.type,objPath(i.model.subject.model,"id")],objPath(i.model,"bonus.bonus_id")&&i.validateBonus()&&(e.bonusId=i.model.bonus.bonus_id),t="toBalanceAfter";break;case"withdraw":e.from=[i.model.subject.type,objPath(i.model.subject.model,"id")],e.to=[i.model.object.type,objPath(i.model.object.model,"id")],t="fromBalanceAfter";break;default:return l.Big.Simple.Error("Undefined transaction type.")}i.model.subject;var o=i.model.balanceField;i.processing=!0,a.call("Cashier.BankGroup.Transaction.moveMoney",e).then(function(e){var n=objPath(e,t);void 0===n?l.Big.Simple.Error("Undefined balance field."):i.model.subject.model[o]=n,i.close()}).then(l.Small.Simple.Success,function(e){var n=r.model.subject.model.wager;return 0<n&&(e+="<br>The player's current wager is: "+s("nnCurrency")(n)),l.Big.Simple.Error(e)}).finally(function(){n.$apply(function(){i.processing=!1})})},i.cancel=function(){i.dismiss()},i.allMoney=function(n){if("playerId"===r.model.subject.type){i.processing=!0;var e=r.model.subject.model.bank_group_id,t=r.model.subject.model.id;a.Cashier.Player.Balance.get({bankGroupId:e,playerId:t}).then(function(e){i.model.subject.balance={available:e.balance,activeBonus:e.active_bonus,wager:e.wager},n?i.model.amount=e.balance:angular.isNumber(i.model.amount)&&(i.model.amount=0)}).finally(function(){i.processing=!1})}else i.processing=!1},i.allMoney(!1),i.bonusValue=function(){var e=i.model.bonus,n=i.model.amount||0;return null!=e.bonus_sum?parseInt(n*e.bonus_percent/1e4):null!=e.bonus_percent?n*e.bonus_percent/1e4:(l.Big.Simple.Error("Bonus is broken."),0)},i.wagerValue=function(){var e=i.model.bonus,n=i.model.amount||0;return null!=e.bonus_sum?parseInt(n*e.bonus_percent/1e4):null!=e.bonus_percent?parseInt(n*e.bonus_percent/1e4)*e.wager_coefficient/1e4:(l.Big.Simple.Error("Bonus is broken."),0)},i.totalValue=function(){return(i.model.amount||0)+r.bonusValue()}}]}).component("balanceChangerSweepstakesComponent",{templateUrl:VIEW_PATH+"/partials/balance-changer/modal-sweepstakes.html",bindings:{close:"&",dismiss:"&",resolve:"="},controller:["Remote","Alert",function(n,o){_.extend(this,this.resolve);var a=this;a.processing=!1,a.ok=function(){if(_.isUndefined(a.model.amount)||a.model.amount<=0)return o.Big.Simple.Error("Amount has to be positive and greater than zero.");var e={amount:("bet2win"===a.model.type?-1:1)*a.model.amount,playerId:objPath(a.model.subject.model,"id")},t=a.model.subject;a.processing=!0,n.call("Cashier.Player.Balance.sweepstakesWin2Bet",e).then(function(n){t.field.ss?_.each(t.field.ss,function(e){t.model[e]=objPath(n,e)}):void 0!==t.model.balanceBet&&void 0!==t.model.balanceWin?(t.model.balanceBet=objPath(n,"balanceBet"),t.model.balanceWin=objPath(n,"balanceWin")):o.Big.Simple.Error("Unknown field. Nothing to update."),a.close()}).then(o.Small.Simple.Success,o.Big.Simple.Error).finally(function(){a.processing=!1})},a.cancel=function(){a.dismiss()}}]}).component("balanceChangerBWComponent",{templateUrl:VIEW_PATH+"/partials/balance-changer/modal-bw.html",bindings:{close:"&",dismiss:"&",resolve:"="},controller:["Remote","Alert",function(a,l){_.extend(this,this.resolve);var s=this;s.processing=!1,s.ok=function(){if(_.isUndefined(s.model.amount)||s.model.amount<=0)return l.Big.Simple.Error("Amount has to be positive and greater than zero.");var e={playerId:objPath(s.model.subject.model,"id"),wagerAmount:0,bonusAmount:0,bonusLimit:0,changeBalance:!1},n="deposit"===s.model.type?s.model.amount:-s.model.amount,t=null;switch(s.model.balanceType){case"bonusBalance":e.bonusAmount=n,t="bonusBalanceAfter";break;case"bonusLimit":e.bonusLimit=n,t="bonusLimitAfter";break;case"wagerCounter":e.wagerAmount=n,t="wagerCounterAfter";break;default:return l.Big.Simple.Error("Undefined balance type.")}s.model.subject;var o=s.model.balanceField;s.processing=!0,a.call("Cashier.Player.Bonus.Balance.change",e).then(function(e){var n=objPath(e,t);void 0===n?l.Big.Simple.Error("Undefined balance field."):s.model.subject.model[o]=n,s.close()}).then(l.Small.Simple.Success,l.Big.Simple.Error).finally(function(){s.processing=!1})},s.cancel=function(){s.dismiss()}}]});